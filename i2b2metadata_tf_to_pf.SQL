--------------------------------------------------------------------------
-- Play this script in I2B2METADATA@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1522/ORCL to make it look like I2B2METADATA@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1523/ORCL
--
-- Please review the script before using it to make sure it won't
-- cause any unacceptable data loss.
--
-- I2B2METADATA@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1522/ORCL Schema Extracted by User SYSTEM 
-- I2B2METADATA@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1523/ORCL Schema Extracted by User SYSTEM 

ALTER TABLE I2B2METADATA.I2B2_TAGS
MODIFY(PATH  NOT NULL);

ALTER TABLE I2B2METADATA.I2B2_TAGS
MODIFY(TAG_TYPE  NOT NULL);

-- Delete duplicate records. Leave the latest entries only.
delete from I2B2METADATA.I2B2_TAGS t1
where t1.TAG_ID not in (
	select max(t2.TAG_ID)
	from I2B2METADATA.I2B2_TAGS t2
	where t1.PATH = t2.PATH
	and t1.TAG_TYPE = t2.TAG_TYPE
);

CREATE UNIQUE INDEX I2B2METADATA.I2B2_TAGS_PATH_TAG_TYPE_KEY ON I2B2METADATA.I2B2_TAGS
(PATH, TAG_TYPE);

ALTER TABLE I2B2METADATA.I2B2_TAGS
 ADD CONSTRAINT I2B2_TAGS_PATH_TAG_TYPE_KEY
  UNIQUE (PATH, TAG_TYPE)
  USING INDEX I2B2METADATA.I2B2_TAGS_PATH_TAG_TYPE_KEY;
