--------------------------------------------------------------------------
-- Play this script in BIOMART@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1522/ORCL to make it look like BIOMART@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1523/ORCL
--
-- Please review the script before using it to make sure it won't
-- cause any unacceptable data loss.
--
-- BIOMART@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1522/ORCL Schema Extracted by User SYSTEM 
-- BIOMART@EC2-54-93-196-236.EU-CENTRAL-1.COMPUTE.AMAZONAWS.COM:1523/ORCL Schema Extracted by User SYSTEM 

ALTER TABLE BIOMART.BIO_ASSAY_ANALYSIS_GWAS
MODIFY(BIO_ASSAY_ANALYSIS_ID  NOT NULL);


-- reasons for the design change?
CREATE TABLE BIOMART.BIO_ASY_ANALYSIS_DATA_EXT
(
  BIO_ASY_ANALYSIS_DATA_ID  NUMBER(22)          NOT NULL,
  EXT_TYPE                  VARCHAR2(20 BYTE),
  EXT_DATA                  VARCHAR2(4000 BYTE)
);

CREATE UNIQUE INDEX BIOMART.BIO_ASY_ANALYSIS_DATA_ID_PK ON BIOMART.BIO_ASY_ANALYSIS_DATA_EXT
(BIO_ASY_ANALYSIS_DATA_ID);

ALTER TABLE BIOMART.BIO_ASY_ANALYSIS_DATA_EXT
 ADD CONSTRAINT BIO_ASY_ANALYSIS_DATA_ID_PK
  PRIMARY KEY
  (BIO_ASY_ANALYSIS_DATA_ID)
  USING INDEX BIOMART.BIO_ASY_ANALYSIS_DATA_ID_PK;



-- exist
CREATE UNIQUE INDEX BIOMART.BIOMARKER_PK ON BIOMART.BIO_MARKER
(BIO_MARKER_ID);

-- exist
CREATE UNIQUE INDEX BIOMART.BIOMARKER_UK ON BIOMART.BIO_MARKER
(ORGANISM, PRIMARY_EXTERNAL_ID);



-- partition management 12bil+ rows, ~1TB, 
-- dropped due to global idx unusable issue, expensive maintenance
CREATE UNIQUE INDEX BIOMART.BIO_ASY_ANALYSIS_GWAS_ID_PK ON BIOMART.BIO_ASSAY_ANALYSIS_GWAS
(BIO_ASY_ANALYSIS_GWAS_ID);

-- unusuable
ALTER TABLE BIOMART.BIO_ASSAY_ANALYSIS_GWAS
 ADD CONSTRAINT BIO_ASY_ANALYSIS_GWAS_ID_PK
  PRIMARY KEY
  (BIO_ASY_ANALYSIS_GWAS_ID)
  USING INDEX BIOMART.BIO_ASY_ANALYSIS_GWAS_ID_PK;

-- design reason?  ref pk of GWAS tab
ALTER TABLE BIOMART.BIO_ASY_ANALYSIS_DATA_EXT
 ADD CONSTRAINT BIO_ASY_ANALYSIS_DATA_EXT_FK 
  FOREIGN KEY (BIO_ASY_ANALYSIS_DATA_ID) 
  REFERENCES BIOMART.BIO_ASSAY_ANALYSIS_GWAS (BIO_ASY_ANALYSIS_GWAS_ID);




-- part of gwas tab?  design??
-- nvarchar2 -> varchar2
CREATE TABLE BIOMART.GWAS_PARTITION
(
  BIO_ASY_ANALYSIS_GWAS_ID  NUMBER(18)          NOT NULL,
  BIO_ASSAY_ANALYSIS_ID     NUMBER(18)          NOT NULL,
  RS_ID                     NVARCHAR2(50),
  P_VALUE_CHAR              VARCHAR2(100 BYTE),
  P_VALUE                   BINARY_DOUBLE,
  LOG_P_VALUE               BINARY_DOUBLE,
  ETL_ID                    NUMBER(18),
  EXT_DATA                  VARCHAR2(4000 BYTE)
)
NOLOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


-- design reason?
ALTER TABLE BIOMART.GWAS_PARTITION
 ADD CONSTRAINT BIO_AA_GWAS_FK 
  FOREIGN KEY (BIO_ASSAY_ANALYSIS_ID) 
  REFERENCES BIOMART.BIO_ASSAY_ANALYSIS (BIO_ASSAY_ANALYSIS_ID);



-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_EXP_ANALYSIS1 ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_EXPERIMENT_ID, BIO_ASSAY_ANALYSIS_ID, BIO_ASY_ANALYSIS_DATA_ID);

-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_PROBE_ID ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_ASSAY_FEATURE_GROUP_ID, BIO_ASY_ANALYSIS_DATA_ID);

-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_PROBE_NAME ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(FEATURE_GROUP_NAME, BIO_ASY_ANALYSIS_DATA_ID);

-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_PROBE_ANALYSIS ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_ASSAY_FEATURE_GROUP_ID, BIO_ASSAY_ANALYSIS_ID);

-- exist, but unnecessary
CREATE INDEX BIOMART.BAAD_IDX_TEA_EXP_ANALYSIS ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_EXPERIMENT_ID, BIO_ASSAY_ANALYSIS_ID);

-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_ANALYSIS ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_ASSAY_ANALYSIS_ID, BIO_ASY_ANALYSIS_DATA_ID);

-- exist
CREATE INDEX BIOMART.BAAD_IDX_TEA_EXPERIMENT_TYPE ON BIOMART.BIO_ASSAY_ANALYSIS_DATA_TEA
(BIO_EXPERIMENT_TYPE, BIO_ASY_ANALYSIS_DATA_ID);


-- ??
ALTER TABLE BIOMART.BIO_MARKER
 RENAME CONSTRAINT SYS_C005648
 TO BIOMARKER_UK;

